# C# 异常捕获

C# 语言的异常处理功能可帮助你处理程序运行时发生的任何意外或异常情况。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/" index="4">4</mcreference> 异常处理使用 `try`、`catch` 和 `finally` 关键字来尝试执行可能不会成功的操作，在你认为合理的情况下处理故障，以及之后清理资源。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/" index="4">4</mcreference>

## 1. `try-catch` 语句

C# 程序员使用 `try` 块来划分可能受异常影响的代码。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference> 关联的 `catch` 块用于处理任何由此产生的异常。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference>

```csharp
try
{
    // 可能引发异常的代码
    int[] numbers = { 1, 2, 3 };
    Console.WriteLine(numbers[5]); // 这会引发 IndexOutOfRangeException
}
catch (IndexOutOfRangeException ex) // 捕获特定类型的异常
{
    // 处理异常的代码
    Console.WriteLine("捕获到数组越界异常: " + ex.Message);
}
catch (Exception ex) // 捕获所有其他类型的异常 (通常建议更具体)
{
    Console.WriteLine("捕获到其他异常: " + ex.Message);
}
```

- **`try` 块**：包含可能引发异常的代码。
- **`catch` 块**：如果 `try` 块中的代码引发了与 `catch` 块中指定的异常类型匹配的异常，则执行 `catch` 块中的代码。
    - 你可以有多个 `catch` 块来处理不同类型的异常。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference>
    - `catch` 块会从上到下进行评估，但对于每个抛出的异常，只会执行一个 `catch` 块。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference> 执行第一个指定了确切类型或所抛出异常的基类的 `catch` 块。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference>
    - 将具有最特定（即派生程度最高）异常类的 `catch` 块放在首位非常重要。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference>
    - 通常，除非你知道如何处理 `try` 块中可能抛出的所有异常，或者已在 `catch` 块的末尾包含 `throw` 语句，否则不要将 `Exception` 指定为异常筛选器。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference>

## 2. `finally` 块

`finally` 块包含无论 `try` 块中是否引发异常都会执行的代码。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference> 例如，释放 `try` 块中分配的资源。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference> `try` 块至少需要一个关联的 `catch` 块或一个 `finally` 块，或者两者都需要。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference>

```csharp
System.IO.StreamReader? reader = null;
try
{
    reader = new System.IO.StreamReader("non_existent_file.txt");
    Console.WriteLine(reader.ReadToEnd());
}
catch (System.IO.FileNotFoundException ex)
{
    Console.WriteLine("文件未找到: " + ex.Message);
}
finally
{
    // 无论是否发生异常，都会执行此代码块
    if (reader != null)
    {
        reader.Close();
        Console.WriteLine("文件读取器已关闭。");
    }
    else
    {
        Console.WriteLine("文件读取器未成功打开。");
    }
}
```

`finally` 块始终运行，无论是否引发异常，或者是否找到与异常类型匹配的 `catch` 块。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference>

## 3. `throw` 语句

`throw` 语句用于显式引发异常。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/" index="4">4</mcreference> 你可以抛出预定义的 .NET 异常，也可以创建自定义异常。

```csharp
public static void CheckAge(int age)
{
    if (age < 18)
    {
        throw new ArgumentException("年龄必须大于或等于 18 岁。");
    }
    else
    {
        Console.WriteLine("年龄有效。");
    }
}

public static void Main(string[] args)
{
    try
    {
        CheckAge(15);
    }
    catch (ArgumentException ex)
    {
        Console.WriteLine("捕获到异常: " + ex.Message);
    }
}
```

你也可以在 `catch` 块中重新抛出当前捕获的异常，通常用于在记录异常或执行某些部分处理后，将异常传递给调用堆栈中更高层的处理程序。

```csharp
try
{
    // ... 可能引发异常的代码 ...
    throw new InvalidOperationException("操作无效");
}
catch (InvalidOperationException ex)
{
    Console.WriteLine("记录错误: " + ex.Message);
    throw; // 重新抛出原始异常，保留原始堆栈跟踪
}
```

如果你在 `catch` 块中使用 `throw ex;` 而不是 `throw;`，它会重置异常的堆栈跟踪，指向当前的 `catch` 块，这可能会丢失原始异常发生位置的重要信息。

## 4. 异常筛选器 (Exception Filters)

你可以为 `catch` 子句添加布尔表达式来指定异常筛选器。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference> 异常筛选器指示仅当该条件为 `true` 时，特定的 `catch` 子句才匹配。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference>

```csharp
public static void ProcessNumber(int number)
{
    try
    {
        if (number < 0)
            throw new ArgumentOutOfRangeException(nameof(number), "数字不能为负数。");
        if (number > 100)
            throw new ArgumentOutOfRangeException(nameof(number), "数字不能大于100。");
        
        Console.WriteLine("处理数字: " + number);
    }
    catch (ArgumentOutOfRangeException ex) when (ex.ParamName == nameof(number) && (int)ex.ActualValue! < 0)
    {
        Console.WriteLine("捕获到负数异常: " + ex.Message);
    }
    catch (ArgumentOutOfRangeException ex) when (ex.ParamName == nameof(number) && (int)ex.ActualValue! > 100)
    {
        Console.WriteLine("捕获到过大数字异常: " + ex.Message);
    }
}

ProcessNumber(-5);    // 输出: 捕获到负数异常: 数字不能为负数。
ProcessNumber(105);   // 输出: 捕获到过大数字异常: 数字不能大于100。
ProcessNumber(50);    // 输出: 处理数字: 50
```

## 5. 何时捕获异常 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference>

在以下情况为 `true` 时捕获异常：

- 你非常清楚为何可能引发异常，并且可以实现特定的恢复措施，例如在捕获 `FileNotFoundException` 对象时提示用户输入新的文件名。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference>
- 你可以创建并引发一个新的、更具体的异常。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference>
- 你希望在将异常传递给更多处理之前部分处理异常。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/exception-handling" index="1">1</mcreference>

一般而言，不要捕获你无法妥善处理的异常。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/" index="4">4</mcreference> 如果没有为给定异常提供异常处理程序，程序将停止执行并显示错误消息。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/" index="4">4</mcreference>

## 6. 常见异常类型

.NET 提供了许多内置的异常类型，它们都派生自 `System.Exception`。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/" index="4">4</mcreference> 一些常见的异常类型包括：

- `System.NullReferenceException`: 当尝试访问值为 `null` 的对象的成员时引发。
- `System.IndexOutOfRangeException`: 当尝试访问数组或集合中索引超出范围的元素时引发。
- `System.IO.IOException`: 当发生 I/O 错误时引发。
    - `System.IO.FileNotFoundException`: 当尝试访问不存在的文件时引发。
- `System.FormatException`: 当参数的格式无效时引发。
- `System.ArgumentException`: 当向方法提供的参数无效时引发。
    - `System.ArgumentNullException`: 当向不接受 `null` 值的方法传递 `null` 参数时引发。
    - `System.ArgumentOutOfRangeException`: 当参数值超出允许的范围时引发。
- `System.InvalidOperationException`: 当方法调用在对象的当前状态下无效时引发。
- `System.DivideByZeroException`: 当尝试将整数或 `Decimal` 值除以零时引发。 <mcreference link="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/" index="4">4</mcreference>

了解这些常见的异常类型有助于编写更健壮的错误处理代码。